#!/bin/sh

if ! test -d .git; then
    echo "Execute scripts/install-git-hooks in the top-level directory."
    exit 1
fi

USR_NAME=$(git config -l | grep -w remote.origin.url | sed -e 's/^.*github.com\/\(.*\)\/lab0-c.git/\1/')

CURL_RES=$(curl \
-H "Accept: application/vnd.github.v3+json" \
https://api.github.com/repos/${USR_NAME}/lab0-c/actions/workflows)

TOTAL_COUNT=$(echo ${CURL_RES} | sed -e 's/.*"total_count": \([^,"]*\).*/\1/')

echo ${TOTAL_COUNT}
if [ ${TOTAL_COUNT} == "0" ]; then
    echo "[WARN] GitHub Action hasn't been activated"
    exit 1
else
    echo "GitHub Action has been activated"
fi

mkdir -p .git/hooks

ln -sf ../../scripts/pre-commit.hook .git/hooks/pre-commit || exit 1
chmod +x .git/hooks/pre-commit

ln -sf ../../scripts/commit-msg.hook .git/hooks/commit-msg || exit 1
chmod +x .git/hooks/commit-msg

ln -sf ../../scripts/pre-push.hook .git/hooks/pre-push || exit 1
chmod +x .git/hooks/pre-push

touch .git/hooks/applied || exit 1

echo
echo "Git hooks are installed successfully."
